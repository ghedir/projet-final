{"ast":null,"code":"// called with all the options already set to their defaults\nconst retrieveTag = require('./retrieve-tag.js');\n\nconst semver = require('semver');\n\nconst enforceClean = require('./enforce-clean.js');\n\nconst writeJson = require('./write-json.js');\n\nconst readJson = require('./read-json.js');\n\nconst git = require('@npmcli/git');\n\nconst commit = require('./commit.js');\n\nconst tag = require('./tag.js');\n\nconst runScript = require('@npmcli/run-script');\n\nmodule.exports = async (newversion, opts) => {\n  const {\n    path,\n    allowSameVersion,\n    gitTagVersion,\n    ignoreScripts,\n    preid,\n    pkg,\n    log\n  } = opts;\n  const {\n    valid,\n    clean,\n    inc\n  } = semver;\n  const current = pkg.version || '0.0.0';\n  const currentClean = clean(current);\n  let newV;\n\n  if (valid(newversion, {\n    loose: true\n  })) {\n    newV = clean(newversion, {\n      loose: true\n    });\n  } else if (newversion === 'from-git') {\n    newV = await retrieveTag(opts);\n  } else {\n    newV = inc(currentClean, newversion, {\n      loose: true\n    }, preid);\n  }\n\n  if (!newV) {\n    throw Object.assign(new Error('Invalid version: ' + newversion), {\n      current,\n      requested: newversion\n    });\n  }\n\n  if (newV === currentClean && !allowSameVersion) {\n    throw Object.assign(new Error('Version not changed'), {\n      current,\n      requested: newversion,\n      newVersion: newV\n    });\n  }\n\n  const isGitDir = newversion === 'from-git' || (await git.is(opts)); // ok!  now we know the new version, and the old version is in pkg\n  // - check if git dir is clean\n  // returns false if we should not keep doing git stuff\n\n  const doGit = gitTagVersion && isGitDir && (await enforceClean(opts));\n\n  if (!ignoreScripts) {\n    await runScript({ ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'preversion',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    });\n  } // - update the files\n\n\n  pkg.version = newV;\n  delete pkg._id;\n  await writeJson(`${path}/package.json`, pkg); // try to update shrinkwrap, but ok if this fails\n\n  const locks = [`${path}/package-lock.json`, `${path}/npm-shrinkwrap.json`];\n  const haveLocks = [];\n\n  for (const lock of locks) {\n    try {\n      const sw = await readJson(lock);\n      sw.version = newV;\n\n      if (sw.packages && sw.packages['']) {\n        sw.packages[''].version = newV;\n      }\n\n      await writeJson(lock, sw);\n      haveLocks.push(lock);\n    } catch (er) {}\n  }\n\n  if (!ignoreScripts) {\n    await runScript({ ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'version',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    });\n  }\n\n  if (doGit) {\n    // - git add, git commit, git tag\n    await git.spawn(['add', `${path}/package.json`], opts); // sometimes people .gitignore their lockfiles\n\n    for (const lock of haveLocks) {\n      await git.spawn(['add', lock], opts).catch(() => {});\n    }\n\n    await commit(newV, opts);\n    await tag(newV, opts);\n  } else {\n    log.verbose('version', 'Not tagging: not in a git repo or no git cmd');\n  }\n\n  if (!ignoreScripts) {\n    await runScript({ ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'postversion',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    });\n  }\n\n  return newV;\n};","map":{"version":3,"sources":["C:/Users/ghedi/Documents/GhedBlog/node_modules/npm/node_modules/libnpmversion/lib/version.js"],"names":["retrieveTag","require","semver","enforceClean","writeJson","readJson","git","commit","tag","runScript","module","exports","newversion","opts","path","allowSameVersion","gitTagVersion","ignoreScripts","preid","pkg","log","valid","clean","inc","current","version","currentClean","newV","loose","Object","assign","Error","requested","newVersion","isGitDir","is","doGit","stdio","event","banner","level","env","npm_old_version","npm_new_version","_id","locks","haveLocks","lock","sw","packages","push","er","spawn","catch","verbose"],"mappings":"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","sourcesContent":["// called with all the options already set to their defaults\n\nconst retrieveTag = require('./retrieve-tag.js')\nconst semver = require('semver')\nconst enforceClean = require('./enforce-clean.js')\nconst writeJson = require('./write-json.js')\nconst readJson = require('./read-json.js')\nconst git = require('@npmcli/git')\nconst commit = require('./commit.js')\nconst tag = require('./tag.js')\n\nconst runScript = require('@npmcli/run-script')\n\nmodule.exports = async (newversion, opts) => {\n  const {\n    path,\n    allowSameVersion,\n    gitTagVersion,\n    ignoreScripts,\n    preid,\n    pkg,\n    log\n  } = opts\n\n  const { valid, clean, inc } = semver\n  const current = pkg.version || '0.0.0'\n  const currentClean = clean(current)\n\n  let newV\n  if (valid(newversion, { loose: true })) {\n    newV = clean(newversion, { loose: true })\n  } else if (newversion === 'from-git') {\n    newV = await retrieveTag(opts)\n  } else {\n    newV = inc(currentClean, newversion, { loose: true }, preid)\n  }\n\n  if (!newV) {\n    throw Object.assign(new Error('Invalid version: ' + newversion), {\n      current,\n      requested: newversion\n    })\n  }\n\n  if (newV === currentClean && !allowSameVersion) {\n    throw Object.assign(new Error('Version not changed'), {\n      current,\n      requested: newversion,\n      newVersion: newV\n    })\n  }\n\n  const isGitDir = newversion === 'from-git' || await git.is(opts)\n\n  // ok!  now we know the new version, and the old version is in pkg\n\n  // - check if git dir is clean\n  // returns false if we should not keep doing git stuff\n  const doGit = gitTagVersion && isGitDir && await enforceClean(opts)\n\n  if (!ignoreScripts) {\n    await runScript({\n      ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'preversion',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    })\n  }\n\n  // - update the files\n  pkg.version = newV\n  delete pkg._id\n  await writeJson(`${path}/package.json`, pkg)\n\n  // try to update shrinkwrap, but ok if this fails\n  const locks = [`${path}/package-lock.json`, `${path}/npm-shrinkwrap.json`]\n  const haveLocks = []\n  for (const lock of locks) {\n    try {\n      const sw = await readJson(lock)\n      sw.version = newV\n      if (sw.packages && sw.packages['']) {\n        sw.packages[''].version = newV\n      }\n      await writeJson(lock, sw)\n      haveLocks.push(lock)\n    } catch (er) {}\n  }\n\n  if (!ignoreScripts) {\n    await runScript({\n      ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'version',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    })\n  }\n\n  if (doGit) {\n    // - git add, git commit, git tag\n    await git.spawn(['add', `${path}/package.json`], opts)\n    // sometimes people .gitignore their lockfiles\n    for (const lock of haveLocks) {\n      await git.spawn(['add', lock], opts).catch(() => {})\n    }\n    await commit(newV, opts)\n    await tag(newV, opts)\n  } else { log.verbose('version', 'Not tagging: not in a git repo or no git cmd') }\n\n  if (!ignoreScripts) {\n    await runScript({\n      ...opts,\n      pkg,\n      stdio: 'inherit',\n      event: 'postversion',\n      banner: log.level !== 'silent',\n      env: {\n        npm_old_version: current,\n        npm_new_version: newV\n      }\n    })\n  }\n\n  return newV\n}\n"]},"metadata":{},"sourceType":"script"}